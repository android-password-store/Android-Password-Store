on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * 1'

env:
  SENTRY_DSN: 'https://public_key@example.com/project_id'

name: Shadow job with latest Gradle and Java
jobs:
  shadow-job:
    strategy:
      fail-fast: false
      matrix:
        agp-version:
          - 7.3.1
          - 7.4.0-rc01
          - 8.0.0-alpha09
        gradle-version:
          - wrapper
          - nightly
        java-version:
          - 11
          - 18
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b # v3.2.0
      with:
        fetch-depth: 0

    - name: Set up JDK
      uses: actions/setup-java@c3ac5dd0ed8db40fedb61c32fbe677e6b355e94c # v3.8.0
      with:
        distribution: temurin
        java-version: ${{ matrix.java-version }}

    - name: Copy CI gradle.properties
      run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties

    - name: Workaround AGP 8.x deprecations
      if: startsWith(matrix.agp-version, '8.0.0')
      run: sed -i 's/android.disableAutomaticComponentCreation=true//' gradle.properties

    - name: Run checks
      uses: gradle/gradle-build-action@3fbe033aaae657f011f88f29be9e65ed26bd29ef # v2.3.3
      env:
        DEP_OVERRIDE: true
        DEP_OVERRIDE_agp: ${{ matrix.agp-version }}
      with:
        arguments: check
        gradle-home-cache-cleanup: true

    - name: Report failure to healthchecks.io
      if: ${{ failure() }}
      env:
        HC_PING_SLUG: ${{ secrets.HC_PING_SLUG }}
        AGP_VERSION: ${{ matrix.agp-version }}
      run: |
        curl --retry 3 --data-raw "AGP: ${AGP_VERSION}" "https://hc-ping.com/${HC_PING_SLUG}/fail"

    - name: Report success to healthchecks.io
      if: ${{ success() }}
      env:
        HC_PING_SLUG: ${{ secrets.HC_PING_SLUG }}
        AGP_VERSION: ${{ matrix.agp-version }}
      run: |
        curl --retry 3 --data-raw "AGP: ${AGP_VERSION}" "https://hc-ping.com/${HC_PING_SLUG}"
